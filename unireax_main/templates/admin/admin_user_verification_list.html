{% extends 'base.html' %}
{% load static %}

{% block title_name %}Подтверждение доступа пользователей{% endblock %}

{% block link_style %}
    {{ block.super }}
{% endblock %}

{% block content %}
<section class="users-panel">
    <div class="users-container">
        <h1 class="users-title">Подтверждение доступа пользователей</h1>
        <p class="users-subtitle">Управление доступом для методистов и преподавателей</p>

        {% if messages %}
        <div class="user-messages">
            {% for message in messages %}
            <div class="user-message {% if message.tags %}user-message-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="users-filters-section">
            <form method="get" class="users-filter-form">
                <div class="users-search-bar">
                    <input type="text" name="search" placeholder="Поиск по ФИО, email, должности или учебному заведению..." value="{{ search_query }}">
                </div>
                
                <select name="status_filter" class="users-select-filter">
                    <option value="">Все статусы</option>
                    <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>Подтверждённые</option>
                    <option value="not_verified" {% if status_filter == 'not_verified' %}selected{% endif %}>Не подтверждённые</option>
                </select>
                
                <select name="role_filter" class="users-select-filter">
                    <option value="">Все роли</option>
                    <option value="metodist" {% if role_filter == 'metodist' %}selected{% endif %}>Методисты</option>
                    <option value="teacher" {% if role_filter == 'teacher' %}selected{% endif %}>Преподаватели</option>
                </select>
                
                <button type="submit" class="users-filter-btn">Применить</button>
                <a href="{% url 'admin_user_verification_list' %}" class="users-reset-btn">Сбросить</a>
            </form>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>ФИО</th>
                        <th>Email</th>
                        <th>Роль</th>
                        <th>Должность</th>
                        <th>Учебное заведение</th>
                        <th>Статус</th>
                        <th>Дата регистрации</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <strong>{{ user.last_name }} {{ user.first_name }}</strong>
                            {% if user.patronymic %}<br>{{ user.patronymic }}{% endif %}
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="user-role-badge user-role-{{ user.role.role_name|slugify }}">
                                {{ user.role.role_name }}
                            </span>
                        </td>
                        <td>{{ user.position|default:"-" }}</td>
                        <td>{{ user.educational_institution|default:"-" }}</td>
                        <td>
                            {% if user.is_verified %}
                                <span class="user-status-verified">Подтверждён</span>
                            {% else %}
                                <span class="user-status-pending">Ожидает подтверждения</span>
                            {% endif %}
                        </td>
                        <td>{{ user.date_joined|date:'d.m.Y' }}</td>
                        <td>
                            <div class="users-actions">
                                <a href="{% url 'admin_user_verification_detail' user.id %}" class="users-action-view">Просмотр и действия</a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="users-no-data">
                            {% if search_query or status_filter or role_filter %}
                                Пользователи по заданным фильтрам не найдены.
                            {% else %}
                                Нет пользователей с ролями "методист" или "преподаватель".
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if users.has_other_pages %}
        <div class="users-pagination">
            <span class="users-pagination-links">
                {% if users.has_previous %}
                    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status_filter={{ status_filter }}{% endif %}{% if role_filter %}&role_filter={{ role_filter }}{% endif %}">&laquo; Первая</a>
                    <a href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status_filter={{ status_filter }}{% endif %}{% if role_filter %}&role_filter={{ role_filter }}{% endif %}">Предыдущая</a>
                {% endif %}

                <span class="users-pagination-current">
                    Страница {{ users.number }} из {{ users.paginator.num_pages }}.
                </span>

                {% if users.has_next %}
                    <a href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status_filter={{ status_filter }}{% endif %}{% if role_filter %}&role_filter={{ role_filter }}{% endif %}">Следующая</a>
                    <a href="?page={{ users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status_filter={{ status_filter }}{% endif %}{% if role_filter %}&role_filter={{ role_filter }}{% endif %}">Последняя &raquo;</a>
                {% endif %}
            </span>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}