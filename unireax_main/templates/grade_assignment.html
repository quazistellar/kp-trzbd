{% extends 'base.html' %}
{% load static %}

{% block title_name %}
Оценивание работы - UNIREAX
{% endblock %}

{% block content %}
<section class="grading-section">
    <div class="grading-container">
        <div class="grading-header">
            <div class="grading-breadcrumb">
                <a href="{% url 'profile' %}">Личный кабинет</a>
                <span class="breadcrumb-separator">/</span>
                <a href="{% url 'course_teach' course.id %}">Преподавание: {{ course.course_name }}</a>
                <span class="breadcrumb-separator">/</span>
                <span>Оценивание работы</span>
            </div>
            
            <h1 class="grading-title">Оценивание работы</h1>
        </div>

        {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="grading-content">
            <div class="submission-info-card">
                <div class="student-info">
                    <h3>Слушатель: {{ submission.user.last_name }} {{ submission.user.first_name }}</h3>
                    <p>Почта: {{ submission.user.email }}</p>
                </div>
                <div class="assignment-info">
                    <h3>Задание: {{ submission.practical_assignment.practical_assignment_name }}</h3>
                    <p>Лекция: {{ submission.practical_assignment.lecture.lecture_name }}</p>
                    <p>Тип оценки: 
                        {% if submission.practical_assignment.grading_type == 'points' %}
                            Бальная система (максимум {{ submission.practical_assignment.max_score }} баллов)
                        {% else %}
                            Зачёт/незачёт
                        {% endif %}
                    </p>
                    <p>Попытка: {{ submission.attempt_number }}</p>
                    {% if submission.submission_date %}
                    <p>Дата сдачи: {{ submission.submission_date|date:"d.m.Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>

            {% if submission.files.all %}
            <div class="files-section">
                <h3>Прикрепленные файлы</h3>
                <div class="files-list">
                    {% for file in submission.files.all %}
                    <div class="file-item">
                        <a href="{{ file.file.url }}" class="file-link" target="_blank" download>
                            <i class="fas fa-file"></i>
                            {{ file.file_name }} ({{ file.file_size|filesizeformat }})
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if submission.comment %}
            <div class="student-comment-section">
                <h3>Комментарий слушателя</h3>
                <div class="comment-box">
                    {{ submission.comment }}
                </div>
            </div>
            {% endif %}

            <div class="grading-form-section">
                <h3>Оценивание работы</h3>
                <form method="post" class="grading-form">
                    {% csrf_token %}
                    
                    {% if submission.practical_assignment.grading_type == 'points' %}
                    <div class="form-group">
                        <label for="score">Баллы (максимум {{ submission.practical_assignment.max_score }}):</label>
                        <input type="number" 
                               id="score" 
                               name="score" 
                               min="0" 
                               max="{{ submission.practical_assignment.max_score }}"
                               value="{{ feedback.score|default:0 }}"
                               class="form-control"
                               required>
                        <small class="form-text">Для бальной системы необходимо указать количество баллов</small>
                    </div>
                    {% else %}
                    <div class="form-group">
                        <label>Оценка:</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" 
                                       name="is_passed" 
                                       value="true"
                                       {% if feedback.is_passed %}checked{% endif %}
                                       required>
                                <span class="radio-text">Зачёт</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" 
                                       name="is_passed" 
                                       value="false"
                                       {% if feedback.is_passed == False %}checked{% endif %}
                                       required>
                                <span class="radio-text">Незачёт</span>
                            </label>
                        </div>
                        <small class="form-text">Для системы "зачёт/незачёт" необходимо выбрать один из вариантов</small>
                    </div>
                    {% endif %}

                    <div class="form-group">
                        <label for="comment_feedback">Комментарий к работе:</label>
                        <textarea id="comment_feedback" 
                                  name="comment_feedback" 
                                  class="form-control" 
                                  rows="5"
                                  placeholder="Оставьте комментарий к работе...">{{ feedback.comment_feedback|default:'' }}</textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-dream">
                            Сохранить оценку
                        </button>
                        <a href="{% url 'course_teach' course.id %}" class="btn-dream">
                            Отмена
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<style>
.messages-container {
    margin-bottom: 20px;
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-family: "Arial Black", sans-serif;
}

.alert-error {
    background: rgba(244, 67, 54, 0.2);
    color: #F44336;
    border: 1px solid rgba(244, 67, 54, 0.4);
}

.alert-success {
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    border: 1px solid rgba(76, 175, 80, 0.4);
}

.form-text {
    color: #BFC3F7;
    font-size: 0.8em;
    margin-top: 5px;
    display: block;
}

.grading-section {
    padding: 20px;
    min-height: 100vh;
}

.grading-container {
    max-width: 1200px;
    margin: 0 auto;
}

.grading-header {
    margin-bottom: 30px;
}

.grading-breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    font-family: "Arial Black", sans-serif;
    color: #ffffffff;
}

.grading-breadcrumb a {
    color: #d6d3d3ff;
    text-decoration: none;
}

.grading-title {
    font-family: "Arial Black", sans-serif;
    color: #FFFFFF;
    font-size: 2em;
    margin: 0;
}

.grading-content {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.submission-info-card {
    background: rgba(21, 29, 73, 0.9);
    border-radius: 15px;
    padding: 25px;
    border: 1px solid rgba(123, 127, 213, 0.3);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

.files-section,
.student-comment-section,
.grading-form-section {
    background: rgba(21, 29, 73, 0.9);
    border-radius: 15px;
    padding: 25px;
    border: 1px solid rgba(123, 127, 213, 0.3);
}

.files-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}

.file-item {
    padding: 12px;
    background: rgba(191, 195, 247, 0.1);
    border-radius: 8px;
    border-left: 4px solid #7B7FD5;
}

.file-link {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #BFC3F7;
    text-decoration: none;
}

.file-link:hover {
    color: #FFFFFF;
}

.comment-box {
    background: rgba(191, 195, 247, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #A020F0;
    color: #FFFFFF;
    line-height: 1.5;
}

.grading-form {
    margin-top: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #FFFFFF;
    margin-bottom: 8px;
    font-family: "Arial Black", sans-serif;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(123, 127, 213, 0.4);
    border-radius: 8px;
    background: rgba(191, 195, 247, 0.1);
    color: #FFFFFF;
    font-family: "Arial Black", sans-serif;
    font-size: 1em;
}

.form-control:focus {
    outline: none;
    border-color: #A020F0;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: #FFFFFF;
    font-family: "Arial Black", sans-serif;
}

.radio-label input[type="radio"] {
    margin: 0;
}

.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

@media (max-width: 768px) {
    .submission-info-card {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}